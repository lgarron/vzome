<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="src/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test react-vzome</title>
  </head>
  <body>
    <div id="root"></div>

    <script type="module">

      import Adapter, { createInstance } from './src/core/adapter.js'
      import * as vZome from './src/core/legacyjava.js'

      const originShown = field =>
      {
        const originBall = createInstance( [ field.origin( 3 ) ] )
        return new Map().set( originBall.id, originBall )
      }

      const fetchModel = ( path ) =>
      {
        // TODO: I should really deploy my own copy of this proxy on Heroku
        const fetchWithCORS = url => fetch ( url ).catch ( _ => fetch( 'https://cors-anywhere.herokuapp.com/' + url ) )

        return fetchWithCORS( path )
          .then( response =>
          {
            if ( !response.ok ) {
              throw new Error( 'Network response was not ok' );
            }
            return response.text()
          })
          .catch( error =>
          {
            console.error( 'There has been a problem with your fetch operation:', error );
            return null
          });
      }

      const url = "/models/120-cell.vZome"

      const { parser } = await vZome.init()  // Must wait for the vZome code to initialize
      const text = await fetchModel( url )
      if ( text ) {
        const { edits, camera, field, parseAndPerformEdit, targetEdit, shaper } = parser( text ) || {}
        if ( edits ) {
          let meshAdapter = new Adapter( originShown( field ), new Map(), new Map() )
          const record = ( adapter ) => {
            meshAdapter = adapter
          } // yup, overwrite every time
          vZome.interpret( vZome.Step.DONE, parseAndPerformEdit, meshAdapter, edits.firstElementChild, [], record )
          console.log( `Successfully interpreted ${url}` )
        }
      }

    </script>
  </body>
</html>
