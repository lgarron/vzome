<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <title>Debug react-vzome</title>

    <script type="module">

import Adapter, { createInstance } from './src/core/adapter.js'
import * as vZome from './src/core/legacyjava.js'

const originShown = field =>
{
  const originBall = createInstance( [ field.origin( 3 ) ] )
  return new Map().set( originBall.id, originBall )
}

const fetchModel = ( path ) =>
{
  // TODO: I should really deploy my own copy of this proxy on Heroku
  const fetchWithCORS = url => fetch ( url ).catch ( _ => fetch( 'https://cors-anywhere.herokuapp.com/' + url ) )

  return fetchWithCORS( path )
    .then( response =>
    {
      if ( !response.ok ) {
        throw new Error( 'Network response was not ok' );
      }
      return response.text()
    })
    .catch( error =>
    {
      console.error( 'There has been a problem with your fetch operation:', error );
      return null
    });
}

const makeVefResourceTable = ( prefix, keys ) => keys.reduce( ( obj, key ) => {
  obj[ key ] = `./src/resources/com/vzome/core/${prefix}/${key}.vef`
  return obj
}, {} )

const groupResources = makeVefResourceTable( 'math/symmetry', [ 'binaryTetrahedralGroup', 'H4roots-rotationalSubgroup', 'H4roots' ] )

const allShapes = {
  'default': makeVefResourceTable( 'parts/default', [ 'connector', 'blue', 'yellow', 'red', 'green' ] ),
}

const url = "/playground/public/models/120-cell.vZome"

const { parser } = await vZome.init( groupResources, allShapes )  // Must wait for the vZome code to initialize
const text = await fetchModel( url )
if ( text ) {
  const { edits, camera, field, parseAndPerformEdit, targetEdit, shaper } = parser( text ) || {}
  if ( edits ) {
    let meshAdapter = new Adapter( originShown( field ), new Map(), new Map() )
    const record = ( adapter ) => {
      meshAdapter = adapter
    } // yup, overwrite every time
    vZome.interpret( vZome.Step.DONE, parseAndPerformEdit, meshAdapter, edits.firstElementChild, [], record )
    console.log( `Successfully interpreted ${url}` )
  }
}

    </script>

  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
  </body>
</html>
